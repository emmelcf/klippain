[gcode_macro _TOOLCHANGER_SAVE_CURRENT_TOOL]
gcode:
  {% set active_tool = printer.toolhead.tool_current %}
  SET_GCODE_VARIABLE MACRO=_TOOLCHANGER_RESTORE_TOOLHEAD_STATE VARIABLE=active_tool VALUE={active_tool}

[gcode_macro _TOOLCHANGER_RESTORE_CURRENT_TOOL]
gcode:
  {% if printer['gcode_macro _TOOLCHANGER_RESTORE_TOOLHEAD_STATE'].active_tool is defined %}
    T{printer['gcode_macro _TOOLCHANGER_RESTORE_TOOLHEAD_STATE'].active_tool}
  {% endif %}

[gcode_macro _TOOLCHANGER_G28_STORE_TOOLHEAD_STATE]
gcode:
  {% if printer.config.has_section('toolchanger') %}
    _TOOLCHANGER_SAVE_CURRENT_TOOL
  {% endif %}

[gcode_macro _TOOLCHANGER_G28_RESTORE_TOOLHEAD_STATE]
gcode:
  {% if printer.config.has_section('toolchanger') %}
    _TOOLCHANGER_RESTORE_CURRENT_TOOL
  {% endif %}